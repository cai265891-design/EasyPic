# Railway Worker ç»Ÿä¸€ä½¿ç”¨ Supabase æ•°æ®åº“

## âœ… å·²å®Œæˆçš„æ¶æ„ä¼˜åŒ–

æœ¬é¡¹ç›®å·²ä¼˜åŒ–ä¸º**ç»Ÿä¸€æ•°æ®åº“æ¶æ„**:
- Web åº”ç”¨ (Vercel) å’Œ Worker æœåŠ¡ (Railway) å…±ç”¨ **Supabase PostgreSQL**
- åˆ é™¤äº† Railway ç‹¬ç«‹çš„ PostgreSQL æ’ä»¶
- é™ä½æˆæœ¬,ç®€åŒ–éƒ¨ç½²å’Œç»´æŠ¤

---

## ğŸ—ï¸ ç»Ÿä¸€åçš„æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase PostgreSQL (ç»Ÿä¸€æ•°æ®åº“)                 â”‚
â”‚  Database: postgres                               â”‚
â”‚  Host: aws-1-us-east-1.pooler.supabase.com       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·è®¤è¯è¡¨ (NextAuth)                       â”‚  â”‚
â”‚  â”‚  - User, Account, Session                  â”‚  â”‚
â”‚  â”‚  - VerificationToken                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ å·¥ä½œæµç³»ç»Ÿè¡¨ (BullMQ Workers)               â”‚  â”‚
â”‚  â”‚  - WorkflowExecution                       â”‚  â”‚
â”‚  â”‚  - Product, Listing                        â”‚  â”‚
â”‚  â”‚  - ImageSet, ProductImage                  â”‚  â”‚
â”‚  â”‚  - RegenerationLog                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                           â†‘
         â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Web åº”ç”¨ â”‚                â”‚Worker æœåŠ¡â”‚
   â”‚(Vercel) â”‚                â”‚(Railway)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Railway Worker ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Railway Worker æœåŠ¡çš„ **Variables** æ ‡ç­¾ä¸­é…ç½®:

### å¿…éœ€å˜é‡

```bash
# æ•°æ®åº“ - ä½¿ç”¨ Supabase (ä¸ Web åº”ç”¨å…±ç”¨)
DATABASE_URL=postgres://postgres.xxx:xxx@aws-1-us-east-1.pooler.supabase.com:6543/postgres?sslmode=require&pgbouncer=true

# Redis - ä½¿ç”¨ Upstash (å…è´¹é¢åº¦)
REDIS_URL=redis://default:xxx@xxx.upstash.io:6379
# æˆ–ä½¿ç”¨ UPSTASH_REDIS_REST_URL + UPSTASH_REDIS_REST_TOKEN

# Claude AI API
ANTHROPIC_API_KEY=sk-ant-xxx

# Cloudflare R2 å­˜å‚¨
CLOUDFLARE_R2_ACCESS_KEY=xxx
CLOUDFLARE_R2_SECRET_KEY=xxx
CLOUDFLARE_R2_ENDPOINT=https://xxx.r2.cloudflarestorage.com
CLOUDFLARE_R2_BUCKET=tushenshi
CLOUDFLARE_R2_PUBLIC_URL=https://pub-xxx.r2.dev
```

**æ³¨æ„**:
- âœ… ä½¿ç”¨ Supabase çš„ **Pooler è¿æ¥** (ç«¯å£ 6543,å¸¦ `pgbouncer=true`)
- âœ… ç¡®ä¿ `sslmode=require` (Supabase éœ€è¦ SSL)
- âŒ ä¸è¦ä½¿ç”¨ Supabase çš„ Direct è¿æ¥ (ç«¯å£ 5432) - Worker å¯èƒ½ä¼šè€—å°½è¿æ¥æ± 

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ (é¦–æ¬¡éƒ¨ç½²æˆ–è¿ç§»)

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Railway Worker æœåŠ¡çš„ Variables ä¸­:
- æ·»åŠ æˆ–æ›´æ–° `DATABASE_URL` ä¸º Supabase è¿æ¥å­—ç¬¦ä¸²
- é…ç½®å…¶ä»–å¿…éœ€å˜é‡ (REDIS_URL, ANTHROPIC_API_KEY ç­‰)

### 2. æ¨é€ä»£ç åˆ° GitHub

```bash
git push origin main
```

Railway ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ã€‚

### 3. éªŒè¯éƒ¨ç½²

æŸ¥çœ‹ Railway Worker çš„ Deployments æ—¥å¿—,ç¡®è®¤:

**æˆåŠŸæ—¥å¿—ç¤ºä¾‹**:
```
ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥...
âœ… DATABASE_URL å·²é…ç½®
ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„...
Datasource "db": PostgreSQL database at "aws-1-us-east-1.pooler.supabase.com:6543"
âœ… æ•°æ®åº“è¡¨ç»“æ„åˆå§‹åŒ–å®Œæˆ
âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡,å¯åŠ¨ Worker...
ğŸš€ æ‰€æœ‰ Worker å·²å¯åŠ¨ï¼Œç­‰å¾…ä»»åŠ¡...
```

### 4. æ£€æŸ¥ Supabase è¡¨

ç™»å½• Supabase æ§åˆ¶å° â†’ Table Editor,åº”è¯¥èƒ½çœ‹åˆ°æ–°å¢çš„è¡¨:
- `WorkflowExecution`
- `Product`
- `Listing`
- `ImageSet`
- `ProductImage`
- `RegenerationLog`

---

## âœ… ç»Ÿä¸€æ•°æ®åº“çš„ä¼˜åŠ¿

### 1. é™ä½æˆæœ¬
- âŒ åˆ é™¤: Railway PostgreSQL æ’ä»¶ (çœç•¥ $5-10/æœˆ)
- âœ… ä½¿ç”¨: Supabase å…è´¹é¢åº¦ (500MB å­˜å‚¨,è¶³å¤Ÿä½¿ç”¨)

### 2. ç®€åŒ–éƒ¨ç½²
- âŒ ä¸éœ€è¦: åœ¨ Railway ç®¡ç†ç‹¬ç«‹æ•°æ®åº“
- âœ… åªéœ€: é…ç½®ä¸€ä¸ª DATABASE_URL ç¯å¢ƒå˜é‡

### 3. æ•°æ®ç»Ÿä¸€
- âœ… Web åº”ç”¨å¯ä»¥ç›´æ¥æŸ¥è¯¢å·¥ä½œæµçŠ¶æ€
- âœ… ç”¨æˆ·æ•°æ®å’Œå·¥ä½œæµæ•°æ®åœ¨åŒä¸€ä¸ªåº“,æ–¹ä¾¿å…³è”æŸ¥è¯¢
- âœ… ç»Ÿä¸€å¤‡ä»½å’Œè¿ç§»

### 4. æ›´å¥½çš„æ€§èƒ½
- âœ… Supabase Pooler è¿æ¥ (è¿æ¥æ± ç®¡ç†)
- âœ… å…¨çƒ CDN åŠ é€Ÿ (AWS Global)
- âœ… è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: Supabase å…è´¹é¢åº¦å¤Ÿç”¨å—?

**A**: å¯¹äºä¸­å°å‹é¡¹ç›®å®Œå…¨å¤Ÿç”¨:
- **å­˜å‚¨**: 500MB (å¯å­˜å‚¨æ•°ä¸‡æ¡å·¥ä½œæµè®°å½•)
- **å¸¦å®½**: 5GB/æœˆ (API è¯·æ±‚)
- **API è¯·æ±‚**: æ— é™åˆ¶

å¦‚æœè¶…å‡º,å¯ä»¥å‡çº§åˆ° Pro è®¡åˆ’ ($25/æœˆ,2TB ä¼ è¾“é‡)ã€‚

### Q2: ä¼šä¸ä¼šå½±å“ Web åº”ç”¨æ€§èƒ½?

**A**: ä¸ä¼š,åŸå› :
- Worker å’Œ Web åº”ç”¨ä½¿ç”¨ä¸åŒçš„è¿æ¥æ± 
- Supabase Pooler è‡ªåŠ¨ç®¡ç†è¿æ¥,é¿å…è€—å°½
- Worker çš„æ•°æ®åº“æ“ä½œæ˜¯å¼‚æ­¥çš„,ä¸é˜»å¡ Web åº”ç”¨

### Q3: å¦‚ä½•ç›‘æ§æ•°æ®åº“ä½¿ç”¨é‡?

**A**: Supabase æ§åˆ¶å°æä¾›è¯¦ç»†ç›‘æ§:
```
Supabase é¡¹ç›® â†’ Settings â†’ Usage
```
å¯ä»¥çœ‹åˆ°:
- å­˜å‚¨ä½¿ç”¨é‡
- è¯·æ±‚æ¬¡æ•°
- è¿æ¥æ•°

### Q4: æ•°æ®å®‰å…¨å—?

**A**: éå¸¸å®‰å…¨:
- âœ… SSL/TLS åŠ å¯†ä¼ è¾“ (`sslmode=require`)
- âœ… Supabase è‡ªåŠ¨å¤‡ä»½ (æ¯æ—¥)
- âœ… Row Level Security (RLS) å¯é€‰
- âœ… ç¬¦åˆ SOC 2 Type II æ ‡å‡†

### Q5: å¦‚ä½•å›æ»šåˆ°ç‹¬ç«‹æ•°æ®åº“?

**A**: å¦‚æœéœ€è¦,å¯ä»¥éšæ—¶åˆ‡æ¢å› Railway PostgreSQL:
1. åœ¨ Railway æ·»åŠ  PostgreSQL æ’ä»¶
2. å°† Worker çš„ DATABASE_URL æ”¹ä¸º Railway çš„è¿æ¥å­—ç¬¦ä¸²
3. é‡æ–°éƒ¨ç½²

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Railway PostgreSQL | Supabase PostgreSQL |
|------|-------------------|---------------------|
| **è¿æ¥å»¶è¿Ÿ** | ~20-50ms (Railway å†…ç½‘) | ~30-60ms (å…¬ç½‘) |
| **è¿æ¥æ± ** | æ‰‹åŠ¨ç®¡ç† | Pooler è‡ªåŠ¨ç®¡ç† âœ… |
| **å¤‡ä»½** | æ‰‹åŠ¨é…ç½® | è‡ªåŠ¨æ¯æ—¥å¤‡ä»½ âœ… |
| **ç›‘æ§** | åŸºç¡€ç›‘æ§ | è¯¦ç»†ç›‘æ§é¢æ¿ âœ… |
| **æˆæœ¬** | $5-10/æœˆ | å…è´¹ (500MB) âœ… |
| **å…¨çƒè®¿é—®** | å•åŒºåŸŸ | å…¨çƒ CDN âœ… |

**ç»“è®º**: Supabase åœ¨æˆæœ¬ã€åŠŸèƒ½ã€æ˜“ç”¨æ€§ä¸Šéƒ½æ›´ä¼˜ã€‚

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Worker å¯åŠ¨æ—¶æç¤º DATABASE_URL æœªè®¾ç½®

**åŸå› **: Railway ç¯å¢ƒå˜é‡æœªæ­£ç¡®é…ç½®

**è§£å†³**:
1. æ£€æŸ¥ Railway Worker çš„ Variables æ ‡ç­¾
2. ç¡®è®¤ `DATABASE_URL` å­˜åœ¨ä¸”å€¼æ­£ç¡®
3. é‡å¯ Worker æœåŠ¡

### é—®é¢˜ 2: è¿æ¥ Supabase è¶…æ—¶

**åŸå› **: ç½‘ç»œé—®é¢˜æˆ– Supabase æœåŠ¡å¼‚å¸¸

**è§£å†³**:
1. æ£€æŸ¥ Supabase çŠ¶æ€: https://status.supabase.com/
2. æ£€æŸ¥ Railway Worker æ—¥å¿—æ˜¯å¦æœ‰è¯¦ç»†é”™è¯¯
3. å°è¯•ä½¿ç”¨ Supabase Direct è¿æ¥ (ç«¯å£ 5432,ä½†ä¸æ¨è)

### é—®é¢˜ 3: è¡¨å·²å­˜åœ¨é”™è¯¯

**åŸå› **: Supabase ä¸­å·²æœ‰åŒåè¡¨

**è§£å†³**:
```bash
# åœ¨ Railway Worker Shell ä¸­æ‰§è¡Œ
npx prisma db push --force-reset --accept-data-loss
```

âš ï¸ è­¦å‘Š: è¿™ä¼šåˆ é™¤ç°æœ‰æ•°æ®!

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase æ•°æ®åº“æ–‡æ¡£](https://supabase.com/docs/guides/database)
- [Prisma è¿æ¥æ± é…ç½®](https://www.prisma.io/docs/guides/performance-and-optimization/connection-management)
- `RAILWAY_DEPLOY_CHECKLIST.md` - Railway éƒ¨ç½²å®Œæ•´æ¸…å•
- `CLAUDE.md` - é¡¹ç›®æ¶æ„è¯´æ˜

---

**æœ€åæ›´æ–°**: 2025-10-31
**æ¶æ„ç‰ˆæœ¬**: v2.0 (ç»Ÿä¸€æ•°æ®åº“)
